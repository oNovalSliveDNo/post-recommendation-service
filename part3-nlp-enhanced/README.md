# üß† –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç (3/4)

## Deep Learning + NLP-–ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ

–ß–∞—Å—Ç—å 3 ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤.

‚¨ÖÔ∏è [–ß–∞—Å—Ç—å 1: Backend + ORM + Baseline](https://github.com/oNovalSliveDNo/post-recommendation-service/tree/main/part1-baseline#readme)  
‚¨ÖÔ∏è [–ß–∞—Å—Ç—å 2: ML-–º–æ–¥–µ–ª—å + Production inference](https://github.com/oNovalSliveDNo/post-recommendation-service/tree/main/part2-ml-model#readme)

---

## üìå –ó–∞–¥–∞—á–∞

–î–æ–ø–æ–ª–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é ML-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ production-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ offline / online
- –Ω–µ –æ–±—É—á–∞—Ç—å –º–æ–¥–µ–ª—å –≤ —Å–µ—Ä–≤–∏—Å–µ (—Ç–æ–ª—å–∫–æ inference)
- —Å–æ–±–ª—é–¥–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
  - ‚è± —Å—Ä–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç ‚â§ 0.5 —Å–µ–∫  
  - üß† RAM ‚â§ 4 –ì–ë  
  - üéØ HitRate ‚â• 0.57  

---

# üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## Offline (–æ–±—É—á–µ–Ω–∏–µ)

```

PostgreSQL
‚Üì
–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ DistilBERT
‚Üì
PCA + KMeans
‚Üì
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è NLP-–ø—Ä–∏–∑–Ω–∞–∫–æ–≤
‚Üì
–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å user-—Ñ–∏—á–∞–º–∏
‚Üì
–û–±—É—á–µ–Ω–∏–µ CatBoost
‚Üì
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (.cbm)
‚Üì
–í—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤ –ë–î

```

–í—Å–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è offline.  
–°–µ—Ä–≤–∏—Å –≤ production –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ inference.

---

## Online (FastAPI —Å–µ—Ä–≤–∏—Å)

```

–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ –ë–î (—á–∞–Ω–∫–∞–º–∏)
‚Üì
–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
‚Üì
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –ª–∞–π–∫–Ω—É—Ç—ã—Ö
‚Üì
ML-—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Üì
Top-K
‚Üì
JSON-–æ—Ç–≤–µ—Ç

```

‚ö† –í–Ω—É—Ç—Ä–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç SQL-–∑–∞–ø—Ä–æ—Å—ã.  
–í—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞.

---

# üìÇ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

| –¢–∞–±–ª–∏—Ü–∞ | –û–±—ä—ë–º |
|----------|--------|
| `user_data` | 163K |
| `post_text` | 7K |
| `feed_data` | 10M |

---

# üß† NLP-—á–∞—Å—Ç—å

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å:

- ü§ñ `distilbert-base-cased`

## –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CLS-–≤–µ–∫—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ 768  
- –†–∞–∑–º–µ—Ä –∏—Ç–æ–≥–æ–≤–æ–π –º–∞—Ç—Ä–∏—Ü—ã: **(7023, 768)**  
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª: `embeddings.npy`

–§–∞–π–ª `embeddings.npy` —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏.  
–ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≤–æ–∑–º–æ–∂–µ–Ω —á–µ—Ä–µ–∑ `dl_pipeline_recsys.ipynb`, –æ–¥–Ω–∞–∫–æ –æ–Ω —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

–î–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:

1Ô∏è‚É£ –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ  
2Ô∏è‚É£ PCA ‚Üí 50 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç  
3Ô∏è‚É£ KMeans ‚Üí 15 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤  

–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:

- `text_cluster`
- `distance_to_cluster_0 ‚Ä¶ 14`
- OHE –ø–æ `topic`

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ NLP-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞, –ø—Ä–∏–≥–æ–¥–Ω–æ–µ –¥–ª—è CatBoost.

---

# üîß User-–ø—Ä–∏–∑–Ω–∞–∫–∏

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ —á–∞—Å—Ç–∏ 2:

- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≥–æ—Ä–æ–¥–µ / —Å—Ç—Ä–∞–Ω–µ  
- OHE –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø  
- OHE `exp_group`  
- –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ `os` –∏ `source`  
- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (`month`, `day`)  

---

# ü§ñ –ú–æ–¥–µ–ª—å

–ê–ª–≥–æ—Ä–∏—Ç–º: `CatBoostClassifier`

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:

- iterations = 500  
- learning_rate = 0.07  
- depth = 6  
- eval_metric = AUC  
- auto_class_weights = Balanced  
- random_seed = 42  

–û–±—É—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞ ~8.5M —Å—Ç—Ä–æ–∫.

–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `get_model_path()` (–∫–∞–∫ –∏ –≤–æ –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞), —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –≤ LMS –∏ –ª–æ–∫–∞–ª—å–Ω–æ.

---

# üìä –ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | Train | Test |
|----------|--------|--------|
| AUC-ROC | ~0.65 | ~0.62 |
| PR-AUC | ~0.16 | ~0.17 |
| F1 | ~0.24 | ~0.25 |

üéØ **HitRate@5 = 0.604**

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ (‚â• 0.57) –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.

---

# ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ~0.5 —Å–µ–∫  
- üß† –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: ‚â§ 4 –ì–ë  
- üöÄ 2000 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É  

---

# üóÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PostgreSQL

–°–æ–∑–¥–∞—é—Ç—Å—è / –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã:

- `processed_user_data`
- `processed_post_text_dl`
- `processed_feed_data_like`
- `clear_post_text`

–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `COPY` (psycopg2) –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è.

–¢–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–µ—Ä–≤–∏—Å–æ–º —á–µ—Ä–µ–∑ batch-–∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –ø–∞–º—è—Ç–∏.

---

# üåê –°–µ—Ä–≤–∏—Å (app.py)

## Endpoint

```

GET /post/recommendations/?id=USER_ID&time=DATETIME&limit=5

```

## –õ–æ–≥–∏–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞

1Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ user-–ø—Ä–∏–∑–Ω–∞–∫–æ–≤  
2Ô∏è‚É£ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–≤—Å–µ –ø–æ—Å—Ç—ã)  
3Ô∏è‚É£ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –ª–∞–π–∫–Ω—É—Ç—ã—Ö  
4Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤  
5Ô∏è‚É£ `predict_proba()`  
6Ô∏è‚É£ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏  
7Ô∏è‚É£ –í–æ–∑–≤—Ä–∞—Ç top-K  

---

# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–∞—Å—Ç–∏ 3

```

part3-nlp-enhanced
‚îú‚îÄ‚îÄ dl_pipeline_recsys.ipynb
‚îú‚îÄ‚îÄ catboost_dl_model.cbm
‚îú‚îÄ‚îÄ embeddings.npy
‚îú‚îÄ‚îÄ app.py
‚îú‚îÄ‚îÄ processed_data/        (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è offline, –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ Git)
‚îú‚îÄ‚îÄ raw_data/              (–Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ Git)
‚îî‚îÄ‚îÄ scripts/

````

---

# ‚öô –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
cp .env.example .env
````

–£–∫–∞–∂–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```
SQLALCHEMY_DATABASE_URL=postgresql://robot-startml-ro:your_password_here@postgres.lab.karpov.courses:6432/startml
```

‚ö† `.env` –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Git.

---

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

`requirements.txt` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

```bash
python -m venv venv
```

Linux / Mac:

```bash
source venv/bin/activate
```

Windows:

```powershell
venv\Scripts\activate
```

–£—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
pip install -r requirements.txt
```

---

# ‚ñ∂ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
cd part3-nlp-enhanced
uvicorn app:app --reload
```

Swagger:

```
http://127.0.0.1:8000/docs
```

---

# ‚úÖ –ò—Ç–æ–≥

* –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ DistilBERT
* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (PCA + KMeans)
* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ production-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ offline / online
* –£–ª—É—á—à–µ–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
* –í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–±–ª—é–¥–µ–Ω—ã

---

## üìé –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

–ß–∞—Å—Ç—å 4 ‚Äî A/B-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –∏ –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞.
