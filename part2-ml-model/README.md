# ๐ค ะคะธะฝะฐะปัะฝัะน ะฟัะพะตะบั (2/4)

## ะะฑััะตะฝะธะต ML-ะผะพะดะตะปะธ ะธ ะธะฝัะตะณัะฐัะธั ะฒ ัะตัะฒะธั ัะตะบะพะผะตะฝะดะฐัะธะน

ะงะฐััั 2 โ ะฟะพัััะพะตะฝะธะต ัะตะบะพะผะตะฝะดะฐัะตะปัะฝะพะน ะผะพะดะตะปะธ ะธ ะฟะพะดะณะพัะพะฒะบะฐ production-ะธะฝัะตัะตะฝัะฐ.

โฌ๏ธ [ะงะฐััั 1: Backend + ORM + Baseline](https://github.com/oNovalSliveDNo/post-recommendation-service/tree/main/part1-baseline#readme)

---

## ๐ ะะฐะดะฐัะฐ

ะะตะฐะปะธะทะพะฒะฐัั ML-ะฟะฐะนะฟะปะฐะนะฝ, ะบะพัะพััะน:

1๏ธโฃ ะะฐะณััะถะฐะตั ะดะฐะฝะฝัะต ะธะท PostgreSQL  
2๏ธโฃ ะกะพะทะดะฐัั ะฟัะธะทะฝะฐะบะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะธ ะฟะพััะพะฒ  
3๏ธโฃ ะะฑััะฐะตั ะผะพะดะตะปั ะฟัะตะดัะบะฐะทะฐะฝะธั ะปะฐะนะบะฐ  
4๏ธโฃ ะกะพััะฐะฝัะตั ะผะพะดะตะปั ะฒ ัะพัะผะฐัะต `.cbm`  
5๏ธโฃ ะะฐะณััะถะฐะตั ะฟัะธะทะฝะฐะบะธ ะฒ ะะ ะดะปั online-ะธะฝัะตัะตะฝัะฐ  

ะฆะตะปะตะฒะฐั ะฟัะพะดะฐะบัะตะฝ-ะผะตััะธะบะฐ โ **HitRate@5**.

> **HitRate@5** โ ะดะพะปั ัะปััะฐะตะฒ, ะบะพะณะดะฐ ัะพัั ะฑั ะพะดะธะฝ ะธะท ะฟััะธ ัะตะบะพะผะตะฝะดะพะฒะฐะฝะฝัั ะฟะพััะพะฒ ะฑัะป ะปะฐะนะบะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ.

---

# ๐ง ะััะธัะตะบัััะฐ

## Offline (ะพะฑััะตะฝะธะต)

```

PostgreSQL
โ
Feature Engineering
โ
CatBoost Training
โ
save_model(.cbm)
โ
ะัะณััะทะบะฐ ะฟัะธะทะฝะฐะบะพะฒ ะฒ ะะ

```

## Online (ัะตัะฒะธั)

```

load_model()
load_features()
โ
predict_proba()
โ
ัะธะปัััะฐัะธั ัะถะต ะปะฐะนะบะฝัััั
โ
top-5 ะฟะพััะพะฒ

```

โ ะะพะดะตะปั **ะฝะต ะพะฑััะฐะตััั ะฒ ัะตัะฒะธัะต**.  
ะะฑััะตะฝะธะต ะฟัะพะธััะพะดะธั offline, ัะตัะฒะธั ะฒัะฟะพะปะฝัะตั ัะพะปัะบะพ inference.

---

## ๐ ะัะฟะพะปัะทัะตะผัะต ะดะฐะฝะฝัะต

| ะขะฐะฑะปะธัะฐ | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| `user_data` | 163K ะฟะพะปัะทะพะฒะฐัะตะปะตะน |
| `post_text_df` | 7K ะฟะพััะพะฒ |
| `feed_data` | 10M ะฒะทะฐะธะผะพะดะตะนััะฒะธะน |

ะะฑััะตะฝะธะต ะฒัะฟะพะปะฝัะตััั ะฝะฐ ัะฐััะธ ัะฐะฑะปะธัั `feed_data` (10M ัััะพะบ).

ะะฐะฝะฝัะต ะฒัะณััะถะฐัััั ัะตัะตะท `scripts/download_raw_data_from_db.py`.

---

# ๐ ะญัะฐะฟั ะฟะฐะนะฟะปะฐะนะฝะฐ

## 1๏ธโฃ ะัะตะดะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ

- ะขะพะบะตะฝะธะทะฐัะธั + ะปะตะผะผะฐัะธะทะฐัะธั (NLTK)
- ะฃะดะฐะปะตะฝะธะต ััะพะฟ-ัะปะพะฒ
- TF-IDF
- PCA (80% ะดะธัะฟะตััะธะธ โ 20 ะบะพะผะฟะพะฝะตะฝั)

ะะตะทัะปััะฐั: `processed_post_text_ml.csv`

---

## 2๏ธโฃ ะัะธะทะฝะฐะบะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

ะะพะฑะฐะฒะปะตะฝั:

- ะะพัะผะฐะปะธะทะฐัะธั ะบะพะปะธัะตััะฒะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ ะณะพัะพะดะต/ัััะฐะฝะต
- ะะพะดะธัะพะฒะฐะฝะธะต `os` ะธ `source`
- OHE ะดะปั ะฒะพะทัะฐััะฝัั ะณััะฟะฟ
- OHE ะดะปั `exp_group`
- ะะพัะผะฐะปะธะทะฐัะธั ะฒัะตะผะตะฝะฝัั ะฟัะธะทะฝะฐะบะพะฒ (month, day)

ะะตะทัะปััะฐั: `processed_user_data.csv`

---

## 3๏ธโฃ ะคะพัะผะธัะพะฒะฐะฝะธะต ะพะฑััะฐััะตะน ะฒัะฑะพัะบะธ

```

feed_data

* user_features
* post_features
  โ 10M ัััะพะบ ร 47 ะฟัะธะทะฝะฐะบะพะฒ

```

ะฆะตะปะตะฒะฐั ะฟะตัะตะผะตะฝะฝะฐั: `target` (ะปะฐะนะบ ะฟะพัะปะต ะฟัะพัะผะพััะฐ)

---

# ๐ค ะะพะดะตะปั

**ะะปะณะพัะธัะผ:** `CatBoostClassifier`

ะะพัะตะผั CatBoost:

- ะบะพััะตะบัะฝะพ ัะฐะฑะพัะฐะตั ั ะบะฐัะตะณะพัะธะฐะปัะฝัะผะธ ะฟัะธะทะฝะฐะบะฐะผะธ  
- ัััะพะนัะธะฒ ะบ ะดะธัะฑะฐะปะฐะฝัั ะบะปะฐััะพะฒ  
- ะฝะต ััะตะฑัะตั ัะปะพะถะฝะพะณะพ preprocessing  
- ััะฐะฑะธะปะตะฝ ะฟัะธ ะฑะพะปััะธั ะพะฑััะผะฐั ะดะฐะฝะฝัั  

ะะฐัะฐะผะตััั:

- iterations = 500  
- learning_rate = 0.07  
- depth = 6  
- eval_metric = AUC  
- auto_class_weights = Balanced  
- random_seed = 42  

---

## ๐ ะะฐัะตััะฒะพ ะผะพะดะตะปะธ

| ะะตััะธะบะฐ | Train | Test |
|----------|--------|--------|
| AUC-ROC | ~0.65 | ~0.62 |
| PR-AUC | ~0.16 | ~0.17 |
| F1 | ~0.24 | ~0.25 |

ะัะพะดะฐะบัะตะฝ-ะผะตััะธะบะฐ:

๐ฏ **HitRate@5 = 0.600**

---

# ๐พ ะกะพััะฐะฝะตะฝะธะต ะผะพะดะตะปะธ

ะคะฐะนะป:

```python
catboost_ml_model.cbm
```

ะคัะฝะบัะธั ะทะฐะณััะทะบะธ:

```python
def load_models():
    model_path = get_model_path("catboost_ml_model.cbm")
    model = CatBoostClassifier()
    model.load_model(model_path)
    return model
````

ะัะฟะพะปัะทัะตััั `get_model_path()` ะดะปั ะบะพััะตะบัะฝะพะน ัะฐะฑะพัั ะฒ LMS
(ะฒ LMS ะผะพะดะตะปั ะฒัะตะณะดะฐ ััะฐะฝะธััั ะฟะพ ะฟััะธ `/workdir/user_input/model`).

---

# ๐ ะัะณััะทะบะฐ ะฟัะธะทะฝะฐะบะพะฒ ะฒ PostgreSQL

ะกะพะทะดะฐะฝั ัะฐะฑะปะธัั:

* `processed_user_data`
* `processed_post_text_ml`
* `processed_feed_data_like`
* `clear_post_text`

ะะฐะณััะทะบะฐ ะฒัะฟะพะปะฝะตะฝะฐ ัะตัะตะท `COPY` (psycopg2) ะดะปั ััะบะพัะตะฝะธั.

ะัะธะทะฝะฐะบะธ ะทะฐะณััะถะฐัััั ะฒ ัะตัะฒะธั ัะฐะฝะบะฐะผะธ (`batch_load_sql`) ะดะปั ัะพะฑะปัะดะตะฝะธั ะพะณัะฐะฝะธัะตะฝะธั:

* RAM โค 4 ะะ

---

# ๐ ะะฝัะตะณัะฐัะธั ะฒ ัะตัะฒะธั

ะ `app.py`:

* ะะพะดะตะปั ะทะฐะณััะถะฐะตััั ะฟัะธ ััะฐััะต ัะตัะฒะธัะฐ
* ะัะธะทะฝะฐะบะธ ะทะฐะณััะถะฐัััั ะพะดะธะฝ ัะฐะท ะฟัะธ ััะฐััะต
* ะะตั SQL-ะทะฐะฟัะพัะพะฒ ะฒะฝัััะธ ัะฝะดะฟะพะธะฝัะฐ
* ะัะตะดัะบะฐะทะฐะฝะธั ะฒัะฟะพะปะฝััััั in-memory
* ะะพััั ัะธะปัััััััั ะพั ัะถะต ะปะฐะนะบะฝัััั

Endpoint:

```
GET /post/recommendations/?id=USER_ID&time=DATETIME&limit=5
```

---

# โ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

ะ ะปะพะบะฐะปัะฝะพะผ ัะตััะธัะพะฒะฐะฝะธะธ:

* ะกัะตะดะฝะตะต ะฒัะตะผั ะทะฐะฟัะพัะฐ: ~0.5 ัะตะบ
* ะะฐะผััั: โค 4 ะะ
* ะกะบะพัะธะฝะณ ะฒัะตั ะบะฐะฝะดะธะดะฐัะพะฒ
* ML-ัะฐะฝะถะธัะพะฒะฐะฝะธะต top-K

---

# ๐ ะกัััะบัััะฐ ัะฐััะธ 2

```
part2-ml-model
โโโ ml_pipeline_recsys.ipynb
โโโ catboost_ml_model.cbm
โโโ app.py
โโโ processed_data/
โโโ raw_data/
โโโ scripts/
```

---

# โ ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต

ะกะพะทะดะฐะนัะต ัะฐะนะป `.env` ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ:

```bash
cp .env.example .env
```

ะฃะบะฐะถะธัะต ัััะพะบั ะฟะพะดะบะปััะตะฝะธั:

```
SQLALCHEMY_DATABASE_URL=postgresql://robot-startml-ro:your_password_here@postgres.lab.karpov.courses:6432/startml
```

โ `.env` ะฝะต ะดะพะฑะฐะฒะปัะตััั ะฒ Git.

---

# ๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
python -m venv venv
```

Linux / Mac:

```bash
source venv/bin/activate
```

Windows:

```powershell
venv\Scripts\activate
```

ะฃััะฐะฝะพะฒะบะฐ:

```bash
pip install -r requirements.txt
```

---

# โถ ะะฐะฟััะบ ัะตัะฒะธัะฐ

```bash
cd part2-ml-model
uvicorn app:app --reload
```

Swagger:

```
http://127.0.0.1:8000/docs
```

---

# โ ะะตะทัะปััะฐั

โ ะะพัััะพะตะฝะฐ ะผะพะดะตะปั ัะตะบะพะผะตะฝะดะฐัะธะน
โ ะะพะดะณะพัะพะฒะปะตะฝั ะฟัะธะทะฝะฐะบะธ ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ
โ ะะตะฐะปะธะทะพะฒะฐะฝ production-inference
โ ะัะพะนะดะตะฝ ัะตะบะตั LMS
โ HitRate@5 > 0.52

---

## ๐ ะกะปะตะดัััะธะน ััะฐะฟ

ะงะฐััั 3 โ Deep Learning ะธ ัะฐััะธัะตะฝะธะต ะฟัะธะทะฝะฐะบะพะฒะพะณะพ ะฟัะพัััะฐะฝััะฒะฐ.
